name: Deploy to Server

on:
  push:
    branches:
      - main  # Change this if you use a different branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # Step 1: Verify server connectivity with Ping
    - name: Check if server is reachable
      run: |
        if ping -c 4 ${{ secrets.SSH_HOST }}; then
          echo "‚úÖ Server is reachable"
        else
          echo "‚ùå Server is unreachable"
          exit 1
        fi

    # Step 2: Check if SSH Port (Default 22) is Open
    - name: Check if SSH port is open
      run: |
        if nc -zv ${{ secrets.SSH_HOST }} 22; then
          echo "‚úÖ Port 22 is open"
        else
          echo "‚ùå Port 22 is closed"
          exit 1
        fi

    # Step 3: Debug SSH Connection with Retry Logic
    - name: Debug SSH Connection
      run: |
        for i in {1..3}; do
          echo "Testing SSH connection (Attempt $i)..."
          ssh -vvv -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo ‚úÖ SSH Connection Successful!" && break || sleep 5
        done || { echo "‚ùå SSH Failed"; exit 1; }

    # Step 4: Deploy to Server
    - name: Deploy to Server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
        echo "üöÄ Starting Deployment..."
        cd /home/devadmin/cnx  # Change this to your actual project path
        echo "üîÑ Pulling latest code..."
        git pull origin main || { echo "‚ùå Git pull failed"; exit 1; }
        
        echo "üîÑ Restarting Docker services..."
        docker compose down || { echo "‚ùå Docker down failed"; exit 1; }
        docker compose up -d --build || { echo "‚ùå Docker build failed"; exit 1; }
        
        echo "‚úÖ Deployment successful!"
        exit
        EOF
